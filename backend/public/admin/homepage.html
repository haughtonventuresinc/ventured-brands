<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage Editor - Ventured Brands CMS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        .section-editor {
            background: white;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .section-title {
            color: #333;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #007bff;
        }
        .form-group {
            margin-bottom: 15px;
        }
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #555;
        }
        .form-control {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
        }
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        .btn-save {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
        }
        .btn-save:hover {
            background: #0056b3;
        }
        .process-card {
            border: 1px solid #eee;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 4px;
        }
        .success-message {
            background: #d4edda;
            color: #155724;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .error-message {
            background: #f8d7da;
            color: #721c24;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 15px;
            display: none;
        }
        .logo-item {
            display: flex;
            gap: 10px;
            margin-bottom: 10px;
            padding: 10px;
            border: 1px solid #eee;
            border-radius: 4px;
        }
        .logo-item input {
            flex: 1;
        }
        /* Hide any stray modals from other pages */
        #pageEditorModal {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <nav class="sidebar">
            <div class="sidebar-header">
                <h3><i class="fas fa-cog"></i> CMS Admin</h3>
            </div>
            <ul class="sidebar-menu">
                <li><a href="index.html"><i class="fas fa-tachometer-alt"></i> Dashboard</a></li>
                <li><a href="pages.html"><i class="fas fa-file-alt"></i> Pages</a></li>
                <li><a href="homepage.html" class="active"><i class="fas fa-home"></i> Homepage</a></li>
                <li><a href="media.html"><i class="fas fa-images"></i> Media Library</a></li>
                <li><a href="users.html"><i class="fas fa-users"></i> Users</a></li>
                <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
            </ul>
        </nav>

        <main class="main-content">
            <div class="content-header">
                <div class="container">
                    <h1>Homepage Editor</h1>
                    <p>Edit the content sections of your homepage</p>
                </div>
            </div>
            
            <div id="loading" style="display: none; text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin"></i> Loading homepage content...
            </div>

            <div class="content-body">
                <!-- Hero Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-star"></i> Hero Section</h3>
                    <div id="hero-success" class="success-message"></div>
                    <div id="hero-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="hero-title">Title</label>
                        <input type="text" id="hero-title" class="form-control" placeholder="Main headline">
                    </div>
                    <div class="form-group">
                        <label for="hero-subtitle">Subtitle</label>
                        <input type="text" id="hero-subtitle" class="form-control" placeholder="Subtitle">
                    </div>
                    <div class="form-group">
                        <label for="hero-headline1">Main Headline 1</label>
                        <input type="text" id="hero-headline1" class="form-control" placeholder="We Invest IN">
                    </div>
                    <div class="form-group">
                        <label for="hero-headline2">Main Headline 2</label>
                        <input type="text" id="hero-headline2" class="form-control" placeholder="Bold Founders">
                    </div>
                    <div class="form-group">
                        <label for="hero-description">Description</label>
                        <textarea id="hero-description" class="form-control" placeholder="Hero description"></textarea>
                    </div>
                    <button onclick="saveHeroSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Hero Section
                    </button>
                </div>

                <!-- Logo Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-building"></i> Logo Section</h3>
                    <div id="logo-success" class="success-message"></div>
                    <div id="logo-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="logo-title">Title (HTML allowed)</label>
                        <input type="text" id="logo-title" class="form-control" placeholder="Section title">
                    </div>
                    <div class="form-group">
                        <label for="logo-description">Description</label>
                        <textarea id="logo-description" class="form-control" placeholder="Section description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="logo-button">Button Text</label>
                        <input type="text" id="logo-button" class="form-control" placeholder="Button text">
                    </div>
                    <button onclick="saveLogoSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Logo Section
                    </button>
                </div>

                <!-- Company Logos Management -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-images"></i> Company Logos</h3>
                    <div id="logos-success" class="success-message"></div>
                    <div id="logos-error" class="error-message"></div>
                    
                    <p>Manage the company logos displayed in the logo section. You can upload new logos or replace existing ones.</p>
                    
                    <div id="logos-container">
                        <!-- Logos will be populated here -->
                    </div>
                    
                    <button onclick="addNewLogo()" class="btn btn-success" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> Add New Logo
                    </button>
                    
                    <button onclick="saveLogos()" class="btn-save" style="margin-top: 15px;">
                        <i class="fas fa-save"></i> Save All Logos
                    </button>
                </div>

                <!-- Benefits Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-lightbulb"></i> Benefits Section</h3>
                    <div id="benefits-success" class="success-message"></div>
                    <div id="benefits-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="benefits-title">Title</label>
                        <input type="text" id="benefits-title" class="form-control" placeholder="Benefits title">
                    </div>
                    <div class="form-group">
                        <label for="benefits-description">Description</label>
                        <textarea id="benefits-description" class="form-control" placeholder="Benefits description"></textarea>
                    </div>
                    <button onclick="saveBenefitsSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Benefits Section
                    </button>
                </div>

                <!-- Process Cards -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-list-ol"></i> Process Cards</h3>
                    <div id="process-success" class="success-message"></div>
                    <div id="process-error" class="error-message"></div>
                    
                    <div id="process-cards-container">
                        <!-- Process cards will be loaded here -->
                    </div>
                    <button onclick="saveProcessCards()" class="btn-save">
                        <i class="fas fa-save"></i> Save Process Cards
                    </button>
                </div>

                <!-- Portfolio Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-briefcase"></i> Portfolio Section</h3>
                    <div id="portfolio-success" class="success-message"></div>
                    <div id="portfolio-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="portfolio-title">Title</label>
                        <input type="text" id="portfolio-title" class="form-control" placeholder="Portfolio title">
                    </div>
                    <div class="form-group">
                        <label for="portfolio-description">Description</label>
                        <textarea id="portfolio-description" class="form-control" placeholder="Portfolio description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="portfolio-button">Button Text</label>
                        <input type="text" id="portfolio-button" class="form-control" placeholder="Button text">
                    </div>
                    <div class="form-group">
                        <label for="portfolio-image">Image</label>
                        <div class="image-upload-container">
                            <input type="file" id="portfolio-image-file" class="form-control" accept="image/*" onchange="handleImageUpload(this, 'portfolio-image', 'portfolio-image-preview')">
                            <input type="text" id="portfolio-image" class="form-control" placeholder="images/portfolio.jpg" readonly>
                            <div class="image-preview" id="portfolio-image-preview"></div>
                        </div>
                    </div>
                    <button onclick="savePortfolioSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Portfolio Section
                    </button>
                </div>

                <!-- Team Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-users"></i> Team Section</h3>
                    <div id="team-success" class="success-message"></div>
                    <div id="team-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="team-title">Title (HTML allowed)</label>
                        <input type="text" id="team-title" class="form-control" placeholder="Team title">
                    </div>
                    <div class="form-group">
                        <label for="team-description">Description</label>
                        <textarea id="team-description" class="form-control" placeholder="Team description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="team-button">Button Text</label>
                        <input type="text" id="team-button" class="form-control" placeholder="Button text">
                    </div>
                    <button onclick="saveTeamSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Team Section
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="js/admin.js"></script>
    <script>
        let homepageData = {};

        // Load homepage content on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Hide any stray modals from other pages
            const modal = document.getElementById('pageEditorModal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.add('hidden');
            }
            
            checkAuth();
            loadHomepageContent();
        });

        // Authentication check function
        function checkAuth() {
            const token = localStorage.getItem('cms_token'); // Fixed: use correct token key
            if (!token) {
                console.log('No token found, redirecting to admin login');
                window.location.href = '/admin/';
                return;
            }
            
            console.log('Token found, proceeding with homepage editor');
        }

        async function loadHomepageContent() {
            try {
                const loadingEl = document.getElementById('loading');
                const contentBodyEl = document.querySelector('.content-body');
                
                if (loadingEl) loadingEl.style.display = 'block';
                if (contentBodyEl) contentBodyEl.style.display = 'none';
                
                const response = await fetch('/api/homepage/content', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    homepageData = result.data;
                    populateForm();
                } else {
                    showError('Failed to load homepage content');
                }
            } catch (error) {
                console.error('Error loading homepage content:', error);
                showError('Failed to load homepage content');
            } finally {
                const loadingEl = document.getElementById('loading');
                const contentBodyEl = document.querySelector('.content-body');
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentBodyEl) contentBodyEl.style.display = 'block';
            }
        }

        function populateForm() {
            // Hero section
            document.getElementById('hero-title').value = homepageData.hero?.title || '';
            document.getElementById('hero-subtitle').value = homepageData.hero?.subtitle || '';
            document.getElementById('hero-headline1').value = homepageData.hero?.headline1 || '';
            document.getElementById('hero-headline2').value = homepageData.hero?.headline2 || '';
            document.getElementById('hero-description').value = homepageData.hero?.description || '';

            // Logo section
            document.getElementById('logo-title').value = homepageData.logoSection?.title || '';
            document.getElementById('logo-description').value = homepageData.logoSection?.description || '';
            document.getElementById('logo-button').value = homepageData.logoSection?.buttonText || '';
            
            // Populate logos
            populateLogos();

            // Benefits section
            document.getElementById('benefits-title').value = homepageData.benefitsSection?.title || '';
            document.getElementById('benefits-description').value = homepageData.benefitsSection?.description || '';

            // Portfolio section
            document.getElementById('portfolio-title').value = homepageData.portfolioSection?.title || '';
            document.getElementById('portfolio-description').value = homepageData.portfolioSection?.description || '';
            document.getElementById('portfolio-button').value = homepageData.portfolioSection?.buttonText || '';
            document.getElementById('portfolio-image').value = homepageData.portfolioSection?.image || '';
            
            // Load portfolio image preview
            if (homepageData.portfolioSection?.image) {
                loadImagePreview(homepageData.portfolioSection.image, 'portfolio-image-preview');
            }

            // Team section
            document.getElementById('team-title').value = homepageData.teamSection?.title || '';
            document.getElementById('team-description').value = homepageData.teamSection?.description || '';
            document.getElementById('team-button').value = homepageData.teamSection?.buttonText || '';

            // Process cards
            populateProcessCards();
        }

        function populateProcessCards() {
            const container = document.getElementById('process-cards-container');
            container.innerHTML = '';

            if (homepageData.processCards) {
                homepageData.processCards.forEach((card, index) => {
                    const cardHtml = `
                        <div class="process-card">
                            <h4>Card ${index + 1}</h4>
                            <div class="form-group">
                                <label>Number</label>
                                <input type="text" id="process-${index}-number" class="form-control" value="${card.number || ''}" placeholder="01">
                            </div>
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="process-${index}-title" class="form-control" value="${card.title || ''}" placeholder="Card title">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="process-${index}-description" class="form-control" placeholder="Card description">${card.description || ''}</textarea>
                            </div>
                        </div>
                    `;
                    container.innerHTML += cardHtml;
                });
            }
        }

        async function saveHeroSection() {
            const data = {
                title: document.getElementById('hero-title').value,
                subtitle: document.getElementById('hero-subtitle').value,
                headline1: document.getElementById('hero-headline1').value,
                headline2: document.getElementById('hero-headline2').value,
                description: document.getElementById('hero-description').value
            };

            await saveSection('hero', data, 'hero-success', 'hero-error');
        }

        async function saveLogoSection() {
            const data = {
                title: document.getElementById('logo-title').value,
                description: document.getElementById('logo-description').value,
                buttonText: document.getElementById('logo-button').value
            };

            await saveSection('logo-section', data, 'logo-success', 'logo-error');
        }

        async function saveBenefitsSection() {
            const data = {
                title: document.getElementById('benefits-title').value,
                description: document.getElementById('benefits-description').value
            };

            await saveSection('benefits', data, 'benefits-success', 'benefits-error');
        }

        async function saveProcessCards() {
            const processCards = [];
            
            for (let i = 0; i < 4; i++) {
                const numberEl = document.getElementById(`process-${i}-number`);
                const titleEl = document.getElementById(`process-${i}-title`);
                const descEl = document.getElementById(`process-${i}-description`);
                
                if (numberEl && titleEl && descEl) {
                    processCards.push({
                        number: numberEl.value,
                        title: titleEl.value,
                        description: descEl.value
                    });
                }
            }

            await saveSection('process-cards', { processCards }, 'process-success', 'process-error');
        }

        async function savePortfolioSection() {
            const data = {
                title: document.getElementById('portfolio-title').value,
                description: document.getElementById('portfolio-description').value,
                buttonText: document.getElementById('portfolio-button').value,
                image: document.getElementById('portfolio-image').value
            };

            await saveSection('portfolio', data, 'portfolio-success', 'portfolio-error');
        }

        async function saveTeamSection() {
            const data = {
                title: document.getElementById('team-title').value,
                description: document.getElementById('team-description').value,
                buttonText: document.getElementById('team-button').value
            };

            await saveSection('team', data, 'team-success', 'team-error');
        }

        async function saveSection(endpoint, data, successId, errorId) {
            try {
                const response = await fetch(`/api/homepage/${endpoint}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message, successId);
                    // Reload content to get updated data
                    await loadHomepageContent();
                } else {
                    showError(result.message, errorId);
                }
            } catch (error) {
                console.error('Error saving section:', error);
                showError('Failed to save section', errorId);
            }
        }

        function showSuccess(message, elementId) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        function showError(message, elementId) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        // Image upload handler
        async function handleImageUpload(fileInput, targetInputId, previewId) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            try {
                // Create FormData for upload
                const formData = new FormData();
                formData.append('file', file);

                // Show upload progress
                const progressContainer = document.createElement('div');
                progressContainer.className = 'upload-progress';
                progressContainer.innerHTML = '<div class="upload-progress-bar" style="width: 0%"></div>';
                fileInput.parentNode.appendChild(progressContainer);

                // Upload file
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update the target input with the uploaded file path
                    document.getElementById(targetInputId).value = result.filePath;
                    
                    // Show preview
                    const previewContainer = document.getElementById(previewId);
                    previewContainer.innerHTML = `<img src="/${result.filePath}" alt="Preview" />`;
                    
                    // Remove progress bar
                    progressContainer.remove();
                    
                    console.log('Image uploaded successfully:', result.filePath);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload image: ' + error.message);
                
                // Remove progress bar on error
                const progressContainer = fileInput.parentNode.querySelector('.upload-progress');
                if (progressContainer) {
                    progressContainer.remove();
                }
            }
        }

        // Load existing image preview
        function loadImagePreview(imagePath, previewId) {
            if (imagePath) {
                const previewContainer = document.getElementById(previewId);
                previewContainer.innerHTML = `<img src="/${imagePath}" alt="Current image" />`;
            }
        }

        // Logo management functions
        function populateLogos() {
            const container = document.getElementById('logos-container');
            container.innerHTML = '';

            if (homepageData.logoSection?.logos) {
                homepageData.logoSection.logos.forEach((logo, index) => {
                    addLogoItem(logo, index);
                });
            }
        }

        function addLogoItem(logo = { image: '', alt: '' }, index = null) {
            const container = document.getElementById('logos-container');
            const logoIndex = index !== null ? index : container.children.length;
            
            const logoItem = document.createElement('div');
            logoItem.className = 'logo-item';
            logoItem.innerHTML = `
                <div class="logo-preview" id="logo-preview-${logoIndex}">
                    ${logo.image ? `<img src="/${logo.image}" alt="${logo.alt}" />` : '<div class="empty">No Image</div>'}
                </div>
                <div class="logo-fields">
                    <div class="form-group">
                        <label>Logo Image</label>
                        <input type="file" accept="image/*" onchange="handleLogoUpload(this, ${logoIndex})" class="form-control">
                        <input type="hidden" id="logo-image-${logoIndex}" value="${logo.image}">
                    </div>
                    <div class="form-group">
                        <label>Alt Text</label>
                        <input type="text" id="logo-alt-${logoIndex}" class="form-control" value="${logo.alt}" placeholder="Company name">
                    </div>
                    <button type="button" class="logo-remove-btn" onclick="removeLogo(${logoIndex})">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            `;
            
            container.appendChild(logoItem);
        }

        function addNewLogo() {
            addLogoItem();
        }

        function removeLogo(index) {
            if (confirm('Are you sure you want to remove this logo?')) {
                const container = document.getElementById('logos-container');
                const logoItems = container.children;
                if (logoItems[index]) {
                    logoItems[index].remove();
                    // Re-index remaining items
                    Array.from(logoItems).forEach((item, newIndex) => {
                        updateLogoIndexes(item, newIndex);
                    });
                }
            }
        }

        function updateLogoIndexes(logoItem, newIndex) {
            // Update all IDs and onclick handlers with new index
            const preview = logoItem.querySelector('.logo-preview');
            const fileInput = logoItem.querySelector('input[type="file"]');
            const hiddenInput = logoItem.querySelector('input[type="hidden"]');
            const altInput = logoItem.querySelector('input[type="text"]');
            const removeBtn = logoItem.querySelector('.logo-remove-btn');

            preview.id = `logo-preview-${newIndex}`;
            fileInput.setAttribute('onchange', `handleLogoUpload(this, ${newIndex})`);
            hiddenInput.id = `logo-image-${newIndex}`;
            altInput.id = `logo-alt-${newIndex}`;
            removeBtn.setAttribute('onclick', `removeLogo(${newIndex})`);
        }

        async function handleLogoUpload(fileInput, logoIndex) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            try {
                // Create FormData for upload
                const formData = new FormData();
                formData.append('file', file);

                // Upload file
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update the hidden input with the uploaded file path
                    document.getElementById(`logo-image-${logoIndex}`).value = result.filePath;
                    
                    // Update preview
                    const previewContainer = document.getElementById(`logo-preview-${logoIndex}`);
                    previewContainer.innerHTML = `<img src="/${result.filePath}" alt="Logo preview" />`;
                    
                    console.log('Logo uploaded successfully:', result.filePath);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Logo upload error:', error);
                alert('Failed to upload logo: ' + error.message);
            }
        }

        async function saveLogos() {
            try {
                const logos = [];
                const container = document.getElementById('logos-container');
                
                Array.from(container.children).forEach((logoItem, index) => {
                    const imageInput = logoItem.querySelector('input[type="hidden"]');
                    const altInput = logoItem.querySelector('input[type="text"]');
                    
                    if (imageInput && altInput) {
                        const image = imageInput.value;
                        const alt = altInput.value;
                        
                        if (image || alt) { // Only save if there's at least an image or alt text
                            logos.push({ image, alt });
                        }
                    }
                });

                await saveSection('logos', { logos }, 'logos-success', 'logos-error');
            } catch (error) {
                console.error('Error saving logos:', error);
                showError('Failed to save logos', 'logos-error');
            }
        }
    </script>
</body>
</html>
