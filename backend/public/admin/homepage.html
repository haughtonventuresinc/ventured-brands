<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Homepage Editor - Ventured Brands CMS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="styles.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #f8f9fa;
            color: #333;
        }
        
        .header {
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #007bff;
            text-decoration: none;
            font-weight: 500;
            font-size: 14px;
            transition: color 0.3s;
        }
        
        .back-link:hover {
            color: #005a87;
        }
        
        .page-title {
            margin: 30px 0 10px 0;
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        .section-editor {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.08);
            border: 1px solid #e9ecef;
        }
        
        .section-title {
            color: #333;
            margin-bottom: 20px;
            padding-bottom: 12px;
            border-bottom: 2px solid #007bff;
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 6px;
            font-size: 14px;
            transition: border-color 0.3s, box-shadow 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007bff;
            box-shadow: 0 0 0 3px rgba(0, 123, 255, 0.1);
        }
        
        textarea.form-control {
            min-height: 120px;
            resize: vertical;
            font-family: inherit;
        }
        
        .btn {
            display: inline-block;
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
            text-decoration: none;
        }
        
        .btn-save {
            background: #007bff;
            color: white;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .process-card {
            border: 1px solid #eee;
            padding: 15px;
        }
        
        .success-message {
            display: none;
            padding: 12px;
            margin: 10px 0;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .error-message {
            display: none;
            padding: 12px;
            margin: 10px 0;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .logo-item {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #e9ecef;
            border-radius: 6px;
            background: #f8f9fa;
        }
        
        .logo-item input {
            flex: 1;
        }
        
        .portfolio-item {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .portfolio-preview {
            width: 80px;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .portfolio-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .team-member {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            padding: 20px;
            border: 1px solid #e9ecef;
            border-radius: 8px;
            background: #f8f9fa;
        }
        
        .team-preview {
            width: 80px;
            height: 80px;
            border: 1px solid #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .team-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .team-fields {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .team-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            height: fit-content;
            align-self: start;
            font-weight: 500;
        }
        
        .team-remove-btn:hover {
            background: #c82333;
        }
        
        .portfolio-fields {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 12px;
        }
        
        .portfolio-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 10px 16px;
            border-radius: 6px;
            cursor: pointer;
            height: fit-content;
            align-self: start;
            font-weight: 500;
        }
        
        .portfolio-remove-btn:hover {
            background: #c82333;
        }
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-bottom: 10px;
        
        .image-preview {
            width: 100%;
            height: 120px;
            border: 2px dashed #ddd;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .image-preview span {
            color: #666;
            font-size: 14px;
        }
        
        .form-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
        
        /* Hide any stray modals from other pages */
        #pageEditorModal {
            display: none !important;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="/admin" class="back-link">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
            <h1 class="page-title">Homepage Editor</h1>
            <p class="page-subtitle">Edit the content sections of your homepage</p>
        </div>
    </div>
    
    <div id="loading" style="display: none; text-align: center; padding: 40px;">
        <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #007bff;"></i>
        <p style="margin-top: 15px; color: #666;">Loading homepage content...</p>
    </div>

    <div class="container">
        <!-- Hero Section -->
        <div class="section-editor">
            <h3 class="section-title"><i class="fas fa-star"></i> Hero Section</h3>
            <div id="hero-success" class="success-message"></div>
            <div id="hero-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="hero-title">Title</label>
                        <input type="text" id="hero-title" class="form-control" placeholder="Main headline">
                    </div>
                    <div class="form-group">
                        <label for="hero-subtitle">Subtitle</label>
                        <input type="text" id="hero-subtitle" class="form-control" placeholder="Subtitle">
                    </div>
                    <div class="form-group">
                        <label for="hero-headline1">Main Headline 1</label>
                        <input type="text" id="hero-headline1" class="form-control" placeholder="We Invest IN">
                    </div>
                    <div class="form-group">
                        <label for="hero-headline2">Main Headline 2</label>
                        <input type="text" id="hero-headline2" class="form-control" placeholder="Bold Founders">
                    </div>
                    <div class="form-group">
                        <label for="hero-description">Description</label>
                        <textarea id="hero-description" class="form-control" placeholder="Hero description"></textarea>
                    </div>
                    <button onclick="saveHeroSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Hero Section
                    </button>
                </div>

                <!-- Logo Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-building"></i> Logo Section</h3>
                    <div id="logo-success" class="success-message"></div>
                    <div id="logo-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="logo-title">Title (HTML allowed)</label>
                        <input type="text" id="logo-title" class="form-control" placeholder="Section title">
                    </div>
                    <div class="form-group">
                        <label for="logo-description">Description</label>
                        <textarea id="logo-description" class="form-control" placeholder="Section description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="logo-button">Button Text</label>
                        <input type="text" id="logo-button" class="form-control" placeholder="Button text">
                    </div>
                    <button onclick="saveLogoSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Logo Section
                    </button>
                </div>

                <!-- Company Logos Management -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-images"></i> Company Logos</h3>
                    <div id="logos-success" class="success-message"></div>
                    <div id="logos-error" class="error-message"></div>
                    
                    <p>Manage the company logos displayed in the logo section. You can upload new logos or replace existing ones.</p>
                    
                    <div id="logos-container">
                        <!-- Logos will be populated here -->
                    </div>
                    
                    <button onclick="addNewLogo()" class="btn btn-success" style="margin-top: 15px;">
                        <i class="fas fa-plus"></i> Add New Logo
                    </button>
                    
                    <button onclick="saveLogos()" class="btn-save" style="margin-top: 15px;">
                        <i class="fas fa-save"></i> Save All Logos
                    </button>
                </div>

                <!-- Benefits Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-lightbulb"></i> Benefits Section</h3>
                    <div id="benefits-success" class="success-message"></div>
                    <div id="benefits-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="benefits-title">Title</label>
                        <input type="text" id="benefits-title" class="form-control" placeholder="Benefits title">
                    </div>
                    <div class="form-group">
                        <label for="benefits-description">Description</label>
                        <textarea id="benefits-description" class="form-control" placeholder="Benefits description"></textarea>
                    </div>
                    <button onclick="saveBenefitsSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Benefits Section
                    </button>
                </div>

                <!-- Process Cards -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-list-ol"></i> Process Cards</h3>
                    <div id="process-success" class="success-message"></div>
                    <div id="process-error" class="error-message"></div>
                    
                    <div id="process-cards-container">
                        <!-- Process cards will be loaded here -->
                    </div>
                    <button onclick="saveProcessCards()" class="btn-save">
                        <i class="fas fa-save"></i> Save Process Cards
                    </button>
                </div>

                <!-- Portfolio Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-briefcase"></i> Portfolio Section</h3>
                    <div id="portfolio-success" class="success-message"></div>
                    <div id="portfolio-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="portfolio-title">Title</label>
                        <input type="text" id="portfolio-title" class="form-control" placeholder="Portfolio title">
                    </div>
                    <div class="form-group">
                        <label for="portfolio-description">Description</label>
                        <textarea id="portfolio-description" class="form-control" placeholder="Portfolio description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="portfolio-button">Button Text</label>
                        <input type="text" id="portfolio-button" class="form-control" placeholder="Button text">
                    </div>
                    <div class="form-group">
                        <label for="portfolio-image">Background Image</label>
                        <div class="image-upload-container">
                            <input type="file" id="portfolio-image-file" class="form-control" accept="image/*" onchange="handleImageUpload(this, 'portfolio-image', 'portfolio-image-preview')">
                            <input type="text" id="portfolio-image" class="form-control" placeholder="images/portfolio.jpg" readonly>
                            <div class="image-preview" id="portfolio-image-preview"></div>
                        </div>
                    </div>
                    
                    <h4>Portfolio Items</h4>
                    <p>Manage the portfolio items displayed in the grid. Each item represents a company/project in your portfolio.</p>
                    
                    <div id="portfolio-items-container">
                        <!-- Portfolio items will be loaded here -->
                    </div>
                    
                    <button onclick="addNewPortfolioItem()" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Portfolio Item
                    </button>
                    
                    <button onclick="savePortfolioSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Portfolio Section
                    </button>
                </div>

                <!-- Team Section -->
                <div class="section-editor">
                    <h3 class="section-title"><i class="fas fa-users"></i> Team Section</h3>
                    <div id="team-success" class="success-message"></div>
                    <div id="team-error" class="error-message"></div>
                    
                    <div class="form-group">
                        <label for="team-title">Title (HTML allowed)</label>
                        <input type="text" id="team-title" class="form-control" placeholder="Team title">
                    </div>
                    <div class="form-group">
                        <label for="team-description">Description</label>
                        <textarea id="team-description" class="form-control" placeholder="Team description"></textarea>
                    </div>
                    <div class="form-group">
                        <label for="team-button">Button Text</label>
                        <input type="text" id="team-button" class="form-control" placeholder="Button text">
                    </div>
                    
                    <h4>Team Members</h4>
                    <p>Manage the team members displayed in the team grid. Each member represents a key person in your organization.</p>
                    
                    <div id="team-members-container">
                        <!-- Team members will be loaded here -->
                    </div>
                    
                    <button onclick="addNewTeamMember()" class="btn btn-success">
                        <i class="fas fa-plus"></i> Add Team Member
                    </button>
                    
                    <button onclick="saveTeamSection()" class="btn-save">
                        <i class="fas fa-save"></i> Save Team Section
                    </button>
                </div>
            </div>
        </main>
    </div>

    <script src="js/admin.js"></script>
    <script>
        let homepageData = {};

        // Load homepage content on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM loaded');
            
            checkAuth();
            loadHomepageContent();
            
            // Attach event listeners to any existing logo remove buttons
            setTimeout(() => {
                attachRemoveButtonListeners();
            }, 1000); // Wait for content to load
        });

        // Authentication check function
        function checkAuth() {
            const token = localStorage.getItem('cms_token'); // Fixed: use correct token key
            if (!token) {
                console.log('No token found, redirecting to admin login');
                window.location.href = '/admin/';
                return;
            }
            
            console.log('Token found, proceeding with homepage editor');
        }

        async function loadHomepageContent() {
            try {
                const loadingEl = document.getElementById('loading');
                const contentBodyEl = document.querySelector('.content-body');
                
                if (loadingEl) loadingEl.style.display = 'block';
                if (contentBodyEl) contentBodyEl.style.display = 'none';
                
                const response = await fetch('/api/homepage/content', {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    }
                });

                const result = await response.json();
                
                if (result.success) {
                    homepageData = result.data;
                    populateForm();
                } else {
                    showError('Failed to load homepage content', 'hero-error');
                }
            } catch (error) {
                console.error('Error loading homepage content:', error);
                showError('Failed to load homepage content', 'hero-error');
            } finally {
                const loadingEl = document.getElementById('loading');
                const contentBodyEl = document.querySelector('.content-body');
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (contentBodyEl) contentBodyEl.style.display = 'block';
            }
        }

        function populateForm() {
            // Hero section
            document.getElementById('hero-title').value = homepageData.hero?.title || '';
            document.getElementById('hero-subtitle').value = homepageData.hero?.subtitle || '';
            document.getElementById('hero-headline1').value = homepageData.hero?.headline1 || '';
            document.getElementById('hero-headline2').value = homepageData.hero?.headline2 || '';
            document.getElementById('hero-description').value = homepageData.hero?.description || '';

            // Logo section
            document.getElementById('logo-title').value = homepageData.logoSection?.title || '';
            document.getElementById('logo-description').value = homepageData.logoSection?.description || '';
            document.getElementById('logo-button').value = homepageData.logoSection?.buttonText || '';
            
            // Populate logos
            populateLogos();

            // Benefits section
            document.getElementById('benefits-title').value = homepageData.benefitsSection?.title || '';
            document.getElementById('benefits-description').value = homepageData.benefitsSection?.description || '';

            // Portfolio section
            console.log('Populating portfolio form with data:', homepageData.portfolioSection);
            document.getElementById('portfolio-title').value = homepageData.portfolioSection?.title || '';
            document.getElementById('portfolio-description').value = homepageData.portfolioSection?.description || '';
            document.getElementById('portfolio-button').value = homepageData.portfolioSection?.buttonText || '';
            document.getElementById('portfolio-image').value = homepageData.portfolioSection?.image || '';
            console.log('Portfolio form populated - Title:', document.getElementById('portfolio-title').value);
            
            // Load portfolio image preview
            if (homepageData.portfolioSection?.image) {
                loadImagePreview(homepageData.portfolioSection.image, 'portfolio-image-preview');
            }
            
            // Populate portfolio items
            populatePortfolioItems();

            // Team section
            document.getElementById('team-title').value = homepageData.teamSection?.title || '';
            document.getElementById('team-description').value = homepageData.teamSection?.description || '';
            document.getElementById('team-button').value = homepageData.teamSection?.buttonText || '';
            
            // Populate team members
            populateTeamMembers();

            // Process cards
            populateProcessCards();
        }

        function populateProcessCards() {
            const container = document.getElementById('process-cards-container');
            container.innerHTML = '';

            if (homepageData.processCards) {
                // Handle both object format {"0": {...}, "1": {...}} and array format
                const processCards = Array.isArray(homepageData.processCards) 
                    ? homepageData.processCards 
                    : Object.values(homepageData.processCards);
                
                processCards.forEach((card, index) => {
                    const cardHtml = `
                        <div class="process-card">
                            <h4>Card ${index + 1}</h4>
                            <div class="form-group">
                                <label>Number</label>
                                <input type="text" id="process-${index}-number" class="form-control" value="${card.number || ''}" placeholder="01">
                            </div>
                            <div class="form-group">
                                <label>Title</label>
                                <input type="text" id="process-${index}-title" class="form-control" value="${card.title || ''}" placeholder="Card title">
                            </div>
                            <div class="form-group">
                                <label>Description</label>
                                <textarea id="process-${index}-description" class="form-control" placeholder="Card description">${card.description || ''}</textarea>
                            </div>
                        </div>
                    `;
                    container.innerHTML += cardHtml;
                });
            }
        }

        async function saveHeroSection() {
            const data = {
                title: document.getElementById('hero-title').value,
                subtitle: document.getElementById('hero-subtitle').value,
                headline1: document.getElementById('hero-headline1').value,
                headline2: document.getElementById('hero-headline2').value,
                description: document.getElementById('hero-description').value
            };

            await saveSection('hero', data, 'hero-success', 'hero-error');
        }

        async function saveLogoSection() {
            const data = {
                title: document.getElementById('logo-title').value,
                description: document.getElementById('logo-description').value,
                buttonText: document.getElementById('logo-button').value
            };

            await saveSection('logo-section', data, 'logo-success', 'logo-error');
        }

        async function saveBenefitsSection() {
            const data = {
                title: document.getElementById('benefits-title').value,
                description: document.getElementById('benefits-description').value
            };

            await saveSection('benefits', data, 'benefits-success', 'benefits-error');
        }

        async function saveProcessCards() {
            const processCards = [];
            
            for (let i = 0; i < 4; i++) {
                const numberEl = document.getElementById(`process-${i}-number`);
                const titleEl = document.getElementById(`process-${i}-title`);
                const descEl = document.getElementById(`process-${i}-description`);
                
                if (numberEl && titleEl && descEl) {
                    processCards.push({
                        number: numberEl.value,
                        title: titleEl.value,
                        description: descEl.value
                    });
                }
            }

            await saveSection('process-cards', { processCards }, 'process-success', 'process-error');
        }

        async function savePortfolioSection() {
            // Collect portfolio items data
            const portfolioItems = [];
            const container = document.getElementById('portfolio-items-container');
            
            console.log('Portfolio container children count:', container.children.length);
            
            // If no portfolio items in the UI, preserve existing ones from homepageData
            if (container.children.length === 0 && homepageData.portfolioSection?.portfolioItems) {
                console.log('No portfolio items in UI, preserving existing data:', homepageData.portfolioSection.portfolioItems);
                portfolioItems.push(...homepageData.portfolioSection.portfolioItems);
            } else {
                Array.from(container.children).forEach((portfolioItem, index) => {
                    const imageInput = portfolioItem.querySelector(`#portfolio-image-${index}`);
                    const altInput = portfolioItem.querySelector(`#portfolio-alt-${index}`);
                    const categoryInput = portfolioItem.querySelector(`#portfolio-category-${index}`);
                    const dateInput = portfolioItem.querySelector(`#portfolio-date-${index}`);
                    const linkInput = portfolioItem.querySelector(`#portfolio-link-${index}`);
                    
                    console.log(`Portfolio item ${index} inputs:`, {
                        image: imageInput?.value,
                        alt: altInput?.value,
                        category: categoryInput?.value,
                        date: dateInput?.value,
                        link: linkInput?.value
                    });
                    
                    if (imageInput && altInput && categoryInput && dateInput && linkInput) {
                        const image = imageInput.value.trim();
                        const alt = altInput.value.trim();
                        const category = categoryInput.value.trim();
                        const date = dateInput.value.trim();
                        const link = linkInput.value.trim();
                        
                        // Save all portfolio items from UI, even if they don't have images yet
                        portfolioItems.push({
                            image: image || '',
                            alt: alt || `Portfolio item ${index + 1}`,
                            category: category || 'Work',
                            date: date || new Date().toLocaleDateString(),
                            link: link || '#'
                        });
                    }
                });
            }

            console.log('Collected portfolio items:', portfolioItems);

            const data = {
                title: document.getElementById('portfolio-title').value,
                description: document.getElementById('portfolio-description').value,
                buttonText: document.getElementById('portfolio-button').value,
                image: document.getElementById('portfolio-image').value,
                portfolioItems: portfolioItems
            };

            console.log('Sending portfolio data:', data);
            await saveSection('portfolio', data, 'portfolio-success', 'portfolio-error');
        }

        async function saveTeamSection() {
            // Collect team members data
            const teamMembers = [];
            const container = document.getElementById('team-members-container');
            
            console.log('Team container children count:', container.children.length);
            
            // If no team members in the UI, preserve existing ones from homepageData
            if (container.children.length === 0 && homepageData.teamSection?.teamMembers) {
                console.log('No team members in UI, preserving existing data:', homepageData.teamSection.teamMembers);
                teamMembers.push(...homepageData.teamSection.teamMembers);
            } else {
                Array.from(container.children).forEach((teamMember, index) => {
                    const nameInput = teamMember.querySelector(`#team-name-${index}`);
                    const titleInput = teamMember.querySelector(`#team-title-${index}`);
                    const imageInput = teamMember.querySelector(`#team-image-${index}`);
                    const altInput = teamMember.querySelector(`#team-alt-${index}`);
                    
                    console.log(`Team member ${index} inputs:`, {
                        name: nameInput?.value,
                        title: titleInput?.value,
                        image: imageInput?.value,
                        alt: altInput?.value
                    });
                    
                    if (nameInput && titleInput && imageInput && altInput) {
                        const name = nameInput.value.trim();
                        const title = titleInput.value.trim();
                        const image = imageInput.value.trim();
                        const alt = altInput.value.trim();
                        
                        // Save all team members from UI
                        teamMembers.push({
                            name: name || `Team Member ${index + 1}`,
                            title: title || 'Team Member',
                            image: image || '',
                            alt: alt || `${name} - ${title}`
                        });
                    }
                });
            }

            console.log('Collected team members:', teamMembers);

            const data = {
                title: document.getElementById('team-title').value,
                description: document.getElementById('team-description').value,
                buttonText: document.getElementById('team-button').value,
                teamMembers: teamMembers
            };

            console.log('Sending team data:', data);
            await saveSection('team', data, 'team-success', 'team-error');
        }

        async function saveSection(endpoint, data, successId, errorId) {
            try {
                const response = await fetch(`/api/homepage/${endpoint}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();

                if (result.success) {
                    showSuccess(result.message, successId);
                    // Reload content to get updated data
                    await loadHomepageContent();
                } else {
                    showError(result.message, errorId);
                }
            } catch (error) {
                console.error('Error saving section:', error);
                showError('Failed to save section', errorId);
            }
        }

        function showSuccess(message, elementId) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.style.display = 'block';
            setTimeout(() => {
                element.style.display = 'none';
            }, 3000);
        }

        function showError(message, elementId) {
            const element = document.getElementById(elementId);
            if (element) {
                element.textContent = message;
                element.style.display = 'block';
                setTimeout(() => {
                    element.style.display = 'none';
                }, 3000);
            } else {
                console.error('Error element not found:', elementId);
                alert(message); // Fallback to alert if element not found
            }
        }

        // Image upload handler
        async function handleImageUpload(fileInput, targetInputId, previewId) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            try {
                // Create FormData for upload
                const formData = new FormData();
                formData.append('file', file);

                // Show upload progress
                const progressContainer = document.createElement('div');
                progressContainer.className = 'upload-progress';
                progressContainer.innerHTML = '<div class="upload-progress-bar" style="width: 0%"></div>';
                fileInput.parentNode.appendChild(progressContainer);

                // Upload file
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update the target input with the uploaded file path
                    document.getElementById(targetInputId).value = result.filePath;
                    
                    // Show preview
                    const previewContainer = document.getElementById(previewId);
                    previewContainer.innerHTML = `<img src="/${result.filePath}" alt="Preview" />`;
                    
                    // Remove progress bar
                    progressContainer.remove();
                    
                    console.log('Image uploaded successfully:', result.filePath);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Upload error:', error);
                alert('Failed to upload image: ' + error.message);
                
                // Remove progress bar on error
                const progressContainer = fileInput.parentNode.querySelector('.upload-progress');
                if (progressContainer) {
                    progressContainer.remove();
                }
            }
        }

        // Load existing image preview
        function loadImagePreview(imagePath, previewId) {
            if (imagePath) {
                const previewContainer = document.getElementById(previewId);
                previewContainer.innerHTML = `<img src="/${imagePath}" alt="Current image" />`;
            }
        }

        // Portfolio items management functions
        function populatePortfolioItems() {
            const container = document.getElementById('portfolio-items-container');
            container.innerHTML = '';

            console.log('Portfolio data:', homepageData.portfolioSection?.portfolioItems);
            
            if (homepageData.portfolioSection?.portfolioItems && homepageData.portfolioSection.portfolioItems.length > 0) {
                homepageData.portfolioSection.portfolioItems.forEach((item, index) => {
                    console.log(`Adding portfolio item ${index}:`, item);
                    addPortfolioItem(item.image, item.alt, item.category, item.date, item.link, index);
                });
            } else {
                console.log('No portfolio items found or array is empty');
            }
            
            // Attach event listeners to all remove buttons
            attachPortfolioRemoveButtonListeners();
        }

        function addPortfolioItem(image = '', alt = '', category = '', date = '', link = '', index = null) {
            const container = document.getElementById('portfolio-items-container');
            const portfolioIndex = index !== null ? index : container.children.length;
            
            const portfolioItem = document.createElement('div');
            portfolioItem.className = 'portfolio-item';
            portfolioItem.innerHTML = `
                <div id="portfolio-preview-${portfolioIndex}" class="portfolio-preview">
                    ${image ? `<img src="/${image}" alt="${alt || 'Portfolio preview'}" />` : '<span>No image</span>'}
                </div>
                <div class="portfolio-fields">
                    <div class="form-group">
                        <label>Image</label>
                        <input type="file" class="form-control" accept="image/*" onchange="handlePortfolioUpload(this, ${portfolioIndex})">
                        <input type="hidden" id="portfolio-image-${portfolioIndex}" name="portfolio-image-${portfolioIndex}" value="${image}">
                    </div>
                    <div class="form-group">
                        <label>Alt Text</label>
                        <input type="text" id="portfolio-alt-${portfolioIndex}" name="portfolio-alt-${portfolioIndex}" class="form-control" placeholder="Company name" value="${alt}">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" id="portfolio-category-${portfolioIndex}" name="portfolio-category-${portfolioIndex}" class="form-control" placeholder="Work" value="${category}">
                    </div>
                    <div class="form-group">
                        <label>Date</label>
                        <input type="text" id="portfolio-date-${portfolioIndex}" name="portfolio-date-${portfolioIndex}" class="form-control" placeholder="1.5.2023" value="${date}">
                    </div>
                    <div class="form-group">
                        <label>Link</label>
                        <input type="text" id="portfolio-link-${portfolioIndex}" name="portfolio-link-${portfolioIndex}" class="form-control" placeholder="work/company.html" value="${link}">
                    </div>
                    <button type="button" class="portfolio-remove-btn" data-index="${portfolioIndex}">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            `;
            
            container.appendChild(portfolioItem);
            
            // Add event listener to the remove button
            const removeBtn = portfolioItem.querySelector('.portfolio-remove-btn');
            removeBtn.addEventListener('click', function() {
                const portfolioItem = this.closest('.portfolio-item');
                const container = document.getElementById('portfolio-items-container');
                const itemIndex = Array.from(container.children).indexOf(portfolioItem);
                removePortfolioItem(itemIndex);
            });
        }

        function addNewPortfolioItem() {
            addPortfolioItem();
        }

        function removePortfolioItem(index) {
            if (confirm('Are you sure you want to remove this portfolio item?')) {
                const container = document.getElementById('portfolio-items-container');
                const portfolioItems = Array.from(container.children);
                
                // Remove the specific item
                if (portfolioItems[index]) {
                    portfolioItems[index].remove();
                    
                    // Re-index all remaining items after removal
                    const remainingItems = Array.from(container.children);
                    remainingItems.forEach((item, newIndex) => {
                        updatePortfolioIndexes(item, newIndex);
                    });
                    
                    // Re-attach event listeners to all buttons
                    attachPortfolioRemoveButtonListeners();
                }
            }
        }

        function updatePortfolioIndexes(portfolioItem, newIndex) {
            // Update all IDs and onclick handlers with new index
            const preview = portfolioItem.querySelector('.portfolio-preview');
            const fileInput = portfolioItem.querySelector('input[type="file"]');
            const hiddenInput = portfolioItem.querySelector('input[type="hidden"]');
            const altInput = portfolioItem.querySelector('input[name$="-alt"]');
            const categoryInput = portfolioItem.querySelector('input[name$="-category"]');
            const dateInput = portfolioItem.querySelector('input[name$="-date"]');
            const linkInput = portfolioItem.querySelector('input[name$="-link"]');
            const removeBtn = portfolioItem.querySelector('.portfolio-remove-btn');

            if (preview) preview.id = `portfolio-preview-${newIndex}`;
            if (fileInput) fileInput.setAttribute('onchange', `handlePortfolioUpload(this, ${newIndex})`);
            if (hiddenInput) {
                hiddenInput.id = `portfolio-image-${newIndex}`;
                hiddenInput.name = `portfolio-image-${newIndex}`;
            }
            if (altInput) {
                altInput.id = `portfolio-alt-${newIndex}`;
                altInput.name = `portfolio-alt-${newIndex}`;
            }
            if (categoryInput) {
                categoryInput.id = `portfolio-category-${newIndex}`;
                categoryInput.name = `portfolio-category-${newIndex}`;
            }
            if (dateInput) {
                dateInput.id = `portfolio-date-${newIndex}`;
                dateInput.name = `portfolio-date-${newIndex}`;
            }
            if (linkInput) {
                linkInput.id = `portfolio-link-${newIndex}`;
                linkInput.name = `portfolio-link-${newIndex}`;
            }
            if (removeBtn) removeBtn.setAttribute('data-index', newIndex);
        }

        function attachPortfolioRemoveButtonListeners() {
            const removeButtons = document.querySelectorAll('.portfolio-remove-btn');
            
            removeButtons.forEach((button, index) => {
                // Remove existing listeners to prevent duplicates
                button.replaceWith(button.cloneNode(true));
                const newButton = document.querySelectorAll('.portfolio-remove-btn')[index];
                
                newButton.addEventListener('click', function() {
                    const portfolioItem = this.closest('.portfolio-item');
                    const container = document.getElementById('portfolio-items-container');
                    const itemIndex = Array.from(container.children).indexOf(portfolioItem);
                    removePortfolioItem(itemIndex);
                });
            });
        }

        async function handlePortfolioUpload(fileInput, portfolioIndex) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            try {
                // Create FormData for upload
                const formData = new FormData();
                formData.append('file', file);

                // Upload file
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update the hidden input with the uploaded file path
                    document.getElementById(`portfolio-image-${portfolioIndex}`).value = result.filePath;
                    
                    // Update preview
                    const previewContainer = document.getElementById(`portfolio-preview-${portfolioIndex}`);
                    previewContainer.innerHTML = `<img src="/${result.filePath}" alt="Portfolio preview" />`;
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Portfolio upload error:', error);
                alert('Failed to upload portfolio image: ' + error.message);
            }
        }

        // Team member management functions
        function populateTeamMembers() {
            const container = document.getElementById('team-members-container');
            container.innerHTML = '';

            console.log('Team members data:', homepageData.teamSection?.teamMembers);
            
            if (homepageData.teamSection?.teamMembers && homepageData.teamSection.teamMembers.length > 0) {
                homepageData.teamSection.teamMembers.forEach((member, index) => {
                    console.log(`Adding team member ${index}:`, member);
                    addTeamMember(member.name, member.title, member.image, member.alt, index);
                });
            } else {
                console.log('No team members found or array is empty');
            }
            
            // Attach event listeners to all remove buttons
            attachTeamRemoveButtonListeners();
        }

        function addTeamMember(name = '', title = '', image = '', alt = '', index = null) {
            const container = document.getElementById('team-members-container');
            const memberIndex = index !== null ? index : container.children.length;
            
            const teamMember = document.createElement('div');
            teamMember.className = 'team-member';
            teamMember.innerHTML = `
                <div id="team-preview-${memberIndex}" class="team-preview">
                    ${image ? `<img src="/${image}" alt="${alt || 'Team member preview'}" />` : '<span>No image</span>'}
                </div>
                <div class="team-fields">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="team-name-${memberIndex}" name="team-name-${memberIndex}" class="form-control" placeholder="Team member name" value="${name}">
                    </div>
                    <div class="form-group">
                        <label>Title/Position</label>
                        <input type="text" id="team-title-${memberIndex}" name="team-title-${memberIndex}" class="form-control" placeholder="PRINCIPAL, PARTNER, etc." value="${title}">
                    </div>
                    <div class="form-group">
                        <label>Image</label>
                        <input type="file" class="form-control" accept="image/*" onchange="handleTeamUpload(this, ${memberIndex})">
                        <input type="hidden" id="team-image-${memberIndex}" name="team-image-${memberIndex}" value="${image}">
                    </div>
                    <div class="form-group">
                        <label>Alt Text</label>
                        <input type="text" id="team-alt-${memberIndex}" name="team-alt-${memberIndex}" class="form-control" placeholder="Alt text for accessibility" value="${alt}">
                    </div>
                    <button type="button" class="team-remove-btn" data-index="${memberIndex}">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            `;
            
            container.appendChild(teamMember);
            
            // Add event listener to the remove button
            const removeBtn = teamMember.querySelector('.team-remove-btn');
            removeBtn.addEventListener('click', function() {
                const teamMember = this.closest('.team-member');
                const container = document.getElementById('team-members-container');
                const itemIndex = Array.from(container.children).indexOf(teamMember);
                removeTeamMember(itemIndex);
            });
        }

        function addNewTeamMember() {
            addTeamMember();
        }

        function removeTeamMember(index) {
            if (confirm('Are you sure you want to remove this team member?')) {
                const container = document.getElementById('team-members-container');
                const teamMembers = Array.from(container.children);
                
                // Remove the specific item
                if (teamMembers[index]) {
                    teamMembers[index].remove();
                    
                    // Re-index all remaining items after removal
                    const remainingItems = Array.from(container.children);
                    remainingItems.forEach((item, newIndex) => {
                        updateTeamIndexes(item, newIndex);
                    });
                    
                    // Re-attach event listeners to all buttons
                    attachTeamRemoveButtonListeners();
                }
            }
        }

        function updateTeamIndexes(teamMember, newIndex) {
            // Update all IDs and onclick handlers with new index
            const preview = teamMember.querySelector('.team-preview');
            const fileInput = teamMember.querySelector('input[type="file"]');
            const nameInput = teamMember.querySelector('input[name$="-name"]');
            const titleInput = teamMember.querySelector('input[name$="-title"]');
            const imageInput = teamMember.querySelector('input[type="hidden"]');
            const altInput = teamMember.querySelector('input[name$="-alt"]');
            const removeBtn = teamMember.querySelector('.team-remove-btn');

            if (preview) preview.id = `team-preview-${newIndex}`;
            if (fileInput) fileInput.setAttribute('onchange', `handleTeamUpload(this, ${newIndex})`);
            if (nameInput) {
                nameInput.id = `team-name-${newIndex}`;
                nameInput.name = `team-name-${newIndex}`;
            }
            if (titleInput) {
                titleInput.id = `team-title-${newIndex}`;
                titleInput.name = `team-title-${newIndex}`;
            }
            if (imageInput) {
                imageInput.id = `team-image-${newIndex}`;
                imageInput.name = `team-image-${newIndex}`;
            }
            if (altInput) {
                altInput.id = `team-alt-${newIndex}`;
                altInput.name = `team-alt-${newIndex}`;
            }
            if (removeBtn) removeBtn.setAttribute('data-index', newIndex);
        }

        function attachTeamRemoveButtonListeners() {
            const removeButtons = document.querySelectorAll('.team-remove-btn');
            removeButtons.forEach(button => {
                button.removeEventListener('click', handleTeamRemove);
                button.addEventListener('click', handleTeamRemove);
            });
        }

        function handleTeamRemove(event) {
            const teamMember = event.target.closest('.team-member');
            const container = document.getElementById('team-members-container');
            const itemIndex = Array.from(container.children).indexOf(teamMember);
            removeTeamMember(itemIndex);
        }

        async function handleTeamUpload(fileInput, memberIndex) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            try {
                // Create FormData for upload
                const formData = new FormData();
                formData.append('file', file);

                // Upload file
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update the hidden input with the uploaded file path
                    document.getElementById(`team-image-${memberIndex}`).value = result.filePath;
                    
                    // Update preview
                    const previewContainer = document.getElementById(`team-preview-${memberIndex}`);
                    previewContainer.innerHTML = `<img src="/${result.filePath}" alt="Team member preview" />`;
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Team upload error:', error);
                alert('Failed to upload team member image: ' + error.message);
            }
        }

        // Logo management functions
        function populateLogos() {
            const container = document.getElementById('logos-container');
            container.innerHTML = '';

            if (homepageData.logoSection?.logos) {
                homepageData.logoSection.logos.forEach((logo, index) => {
                    addLogoItem(logo.image, logo.alt, index);
                });
            }
            
            // Attach event listeners to all remove buttons
            attachRemoveButtonListeners();
        }
        
        function attachRemoveButtonListeners() {
            const removeButtons = document.querySelectorAll('.logo-remove-btn');
            
            removeButtons.forEach((button, index) => {
                // Remove existing listeners to prevent duplicates
                button.replaceWith(button.cloneNode(true));
                const newButton = document.querySelectorAll('.logo-remove-btn')[index];
                
                newButton.addEventListener('click', function() {
                    const logoItem = this.closest('.logo-item');
                    const container = document.getElementById('logos-container');
                    const itemIndex = Array.from(container.children).indexOf(logoItem);
                    removeLogo(itemIndex);
                });
            });
        }

        function addLogoItem(image = '', alt = '', index = null) {
            const container = document.getElementById('logos-container');
            const logoIndex = index !== null ? index : container.children.length;
            
            const logoItem = document.createElement('div');
            logoItem.className = 'logo-item';
            logoItem.innerHTML = `
                <div id="logo-preview-${logoIndex}" class="logo-preview">
                    ${image ? `<img src="/${image}" alt="${alt || 'Logo preview'}" />` : '<span>No image</span>'}
                </div>
                <div class="logo-fields">
                    <div class="form-group">
                        <label>Logo Image</label>
                        <input type="file" class="form-control" accept="image/*" onchange="handleLogoUpload(this, ${logoIndex})">
                        <input type="hidden" id="logo-image-${logoIndex}" name="logo-image-${logoIndex}" value="${image}">
                    </div>
                    <div class="form-group">
                        <label>Alt Text</label>
                        <input type="text" id="logo-alt-${logoIndex}" name="logo-alt-${logoIndex}" class="form-control" placeholder="Company name" value="${alt}">
                    </div>
                    <button type="button" class="logo-remove-btn" data-index="${logoIndex}">
                        <i class="fas fa-trash"></i> Remove
                    </button>
                </div>
            `;
            
            container.appendChild(logoItem);
            
            // Add event listener to the remove button
            const removeBtn = logoItem.querySelector('.logo-remove-btn');
            removeBtn.addEventListener('click', function() {
                const logoItem = this.closest('.logo-item');
                const container = document.getElementById('logos-container');
                const itemIndex = Array.from(container.children).indexOf(logoItem);
                removeLogo(itemIndex);
            });
        }

        function addNewLogo() {
            addLogoItem();
        }

        function removeLogo(index) {
            // Add confirmation dialog (works in regular browsers)
            if (confirm('Are you sure you want to remove this logo?')) {
                const container = document.getElementById('logos-container');
                const logoItems = Array.from(container.children);
                
                // Remove the specific item
                if (logoItems[index]) {
                    logoItems[index].remove();
                    
                    // Re-index all remaining items after removal
                    const remainingItems = Array.from(container.children);
                    remainingItems.forEach((item, newIndex) => {
                        updateLogoIndexes(item, newIndex);
                    });
                    
                    // Re-attach event listeners to all buttons
                    attachRemoveButtonListeners();
                }
            }
        }

        function updateLogoIndexes(logoItem, newIndex) {
            // Update all IDs and onclick handlers with new index
            const preview = logoItem.querySelector('.logo-preview');
            const fileInput = logoItem.querySelector('input[type="file"]');
            const hiddenInput = logoItem.querySelector('input[type="hidden"]');
            const altInput = logoItem.querySelector('input[type="text"]');
            const removeBtn = logoItem.querySelector('.logo-remove-btn');

            if (preview) preview.id = `logo-preview-${newIndex}`;
            if (fileInput) fileInput.setAttribute('onchange', `handleLogoUpload(this, ${newIndex})`);
            if (hiddenInput) {
                hiddenInput.id = `logo-image-${newIndex}`;
                hiddenInput.name = `logo-image-${newIndex}`;
            }
            if (altInput) {
                altInput.id = `logo-alt-${newIndex}`;
                altInput.name = `logo-alt-${newIndex}`;
            }
            if (removeBtn) removeBtn.setAttribute('onclick', `removeLogo(${newIndex})`);
        }

        async function handleLogoUpload(fileInput, logoIndex) {
            const file = fileInput.files[0];
            if (!file) return;

            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                return;
            }

            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('File size must be less than 5MB');
                return;
            }

            try {
                // Create FormData for upload
                const formData = new FormData();
                formData.append('file', file);

                // Upload file
                const response = await fetch('/api/upload/image', {
                    method: 'POST',
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('cms_token')}`
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    // Update the hidden input with the uploaded file path
                    document.getElementById(`logo-image-${logoIndex}`).value = result.filePath;
                    
                    // Update preview
                    const previewContainer = document.getElementById(`logo-preview-${logoIndex}`);
                    previewContainer.innerHTML = `<img src="/${result.filePath}" alt="Logo preview" />`;
                    
                    console.log('Logo uploaded successfully:', result.filePath);
                } else {
                    throw new Error(result.message || 'Upload failed');
                }
            } catch (error) {
                console.error('Logo upload error:', error);
                alert('Failed to upload logo: ' + error.message);
            }
        }

        async function saveLogos() {
            try {
                const logos = [];
                const container = document.getElementById('logos-container');
                
                console.log('Saving logos, found', container.children.length, 'logo items');
                
                Array.from(container.children).forEach((logoItem, index) => {
                    const imageInput = logoItem.querySelector('input[type="hidden"]');
                    const altInput = logoItem.querySelector('input[type="text"]');
                    
                    if (imageInput && altInput) {
                        const image = imageInput.value.trim();
                        const alt = altInput.value.trim();
                        
                        console.log(`Logo ${index}:`, { image, alt });
                        
                        if (image) { // Only save if there's an image
                            logos.push({ 
                                image: image,
                                alt: alt || `Logo ${index + 1}` // Default alt text if empty
                            });
                        }
                    }
                });

                console.log('Final logos array:', logos);
                await saveSection('logos', { logos }, 'logos-success', 'logos-error');
            } catch (error) {
                console.error('Error saving logos:', error);
                showError('Failed to save logos', 'logos-error');
            }
        }
    </script>
</body>
</html>
