<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>About Page Editor - Ventured Brands CMS</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            line-height: 1.6;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: #fff;
            border-bottom: 1px solid #e9ecef;
            padding: 20px 0;
            position: sticky;
            top: 0;
            z-index: 1000;
        }
        
        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }
        
        .breadcrumb {
            color: #666;
            font-size: 14px;
        }
        
        .breadcrumb a {
            color: #007cba;
            text-decoration: none;
        }
        
        .section {
            background: white;
            border-radius: 8px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #007cba;
            padding-bottom: 10px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        
        .form-control {
            width: 100%;
            padding: 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            transition: border-color 0.3s;
        }
        
        .form-control:focus {
            outline: none;
            border-color: #007cba;
            box-shadow: 0 0 0 2px rgba(0, 124, 186, 0.1);
        }
        
        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }
        
        .btn {
            background: #007cba;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: background-color 0.3s;
        }
        
        .btn:hover {
            background: #005a8b;
        }
        
        .btn-secondary {
            background: #6c757d;
        }
        
        .btn-secondary:hover {
            background: #545b62;
        }
        
        .btn-success {
            background: #28a745;
        }

        .success-message {
            display: none;
            padding: 12px;
            margin: 10px 0;
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
            border-radius: 4px;
            font-size: 14px;
        }

        .error-message {
            display: none;
            padding: 12px;
            margin: 10px 0;
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .btn-success:hover {
            background: #218838;
        }
        
        .btn-danger {
            background: #dc3545;
        }
        
        .btn-danger:hover {
            background: #c82333;
        }
        
        .alert {
            padding: 12px 16px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
        
        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .alert-error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .team-member {
            display: flex;
            gap: 15px;
            margin-bottom: 15px;
            padding: 15px;
            border: 1px solid #eee;
            border-radius: 4px;
            background: #f9f9f9;
        }
        
        .team-preview {
            width: 60px;
            height: 60px;
            border: 1px solid #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: white;
            overflow: hidden;
            flex-shrink: 0;
        }
        
        .team-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .team-fields {
            flex: 1;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 10px;
        }
        
        .team-remove-btn {
            background: #dc3545;
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 4px;
            cursor: pointer;
            height: fit-content;
            align-self: start;
        }
        
        .team-remove-btn:hover {
            background: #c82333;
        }

        .gallery-slide {
            display: flex;
            gap: 15px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-bottom: 15px;
            background: #f9f9f9;
        }

        .gallery-fields {
            flex: 1;
        }

        .gallery-slide .image-preview {
            width: 120px;
            height: 80px;
            border: 2px dashed #ccc;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f5f5f5;
            flex-shrink: 0;
        }

        .gallery-slide .image-preview img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 4px;
        }
        
        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .back-link {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            color: #007cba;
            text-decoration: none;
            font-weight: 500;
            margin-bottom: 20px;
        }
        
        .back-link:hover {
            color: #005a87;
        }
        
        .page-title {
            margin: 30px 0 10px 0;
            font-size: 28px;
            font-weight: 600;
            color: #333;
        }
        
        .page-subtitle {
            color: #666;
            font-size: 16px;
            margin-bottom: 30px;
        }
        
        .image-preview {
            width: 100%;
            height: 120px;
            border: 2px dashed #ddd;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: #f9f9f9;
            margin-bottom: 10px;
            overflow: hidden;
        }
        
        .image-preview img {
            max-width: 100%;
            max-height: 100%;
            object-fit: cover;
        }
        
        .image-preview span {
            color: #666;
            font-size: 14px;
        }
        
        .form-text {
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <a href="/admin" class="back-link">
                <i class="fas fa-arrow-left"></i>
                Back to Dashboard
            </a>
            <h1 class="page-title">About Page Editor</h1>
            <p class="page-subtitle">Edit the content sections of your About page</p>
        </div>
    </div>

    <div class="container">
        <!-- Hero Section -->
        <div class="section">
            <h2 class="section-title">Hero Section</h2>
            <div class="alert alert-success" id="hero-success"></div>
            <div class="alert alert-error" id="hero-error"></div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="hero-subtitle">Subtitle</label>
                    <input type="text" id="hero-subtitle" class="form-control" placeholder="Empowering Brand Excellence">
                </div>
                <div class="form-group">
                    <label for="hero-story-title">Story Title</label>
                    <input type="text" id="hero-story-title" class="form-control" placeholder="Our Story">
                </div>
            </div>
            
            <div class="form-group">
                <label for="hero-description">Description</label>
                <textarea id="hero-description" class="form-control" placeholder="We are a premier brand management company..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="hero-image">Hero Image</label>
                <div id="hero-image-preview" class="image-preview">
                    <span>No image selected</span>
                </div>
                <input type="file" class="form-control" accept="image/*" onchange="handleHeroImageUpload(this)" style="margin-top: 10px;">
                <input type="hidden" id="hero-image" name="hero-image">
                <small class="form-text">Upload a new image or use existing URL</small>
                <input type="text" id="hero-image-url" class="form-control" placeholder="Or paste image URL..." style="margin-top: 5px;" onchange="updateHeroImageFromUrl(this.value)">
            </div>
            
            <button onclick="saveHeroSection()" class="btn">Save Hero Section</button>
        </div>

        <!-- Story Intro Section -->
        <div class="section">
            <h2 class="section-title">Story Intro Section</h2>
            <div class="alert alert-success" id="story-intro-success"></div>
            <div class="alert alert-error" id="story-intro-error"></div>
            
            <div class="form-group">
                <label for="story-intro-title">Title</label>
                <input type="text" id="story-intro-title" class="form-control" placeholder="We are Ventured Brands">
            </div>
            
            <div class="form-group">
                <label for="story-intro-description">Description</label>
                <textarea id="story-intro-description" class="form-control" placeholder="A premier brand management company..."></textarea>
            </div>
            
            <button onclick="saveStoryIntroSection()" class="btn">Save Story Intro</button>
        </div>

        <!-- Story Section -->
        <div class="section">
            <h2 class="section-title">Story Section</h2>
            <div class="alert alert-success" id="story-success"></div>
            <div class="alert alert-error" id="story-error"></div>
            
            <div class="form-group">
                <label for="story-title">Title</label>
                <input type="text" id="story-title" class="form-control" placeholder="Our Journey">
            </div>
            
            <div class="form-group">
                <label for="story-description">Description</label>
                <textarea id="story-description" class="form-control" placeholder="Founded with a vision..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="story-content">Content</label>
                <textarea id="story-content" class="form-control" placeholder="We believe that great brands..."></textarea>
            </div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="story-image1">Story Image 1</label>
                    <div id="story-image1-preview" class="image-preview">
                        <span>No image selected</span>
                    </div>
                    <input type="file" class="form-control" accept="image/*" onchange="handleStoryImageUpload(this, 1)" style="margin-top: 10px;">
                    <input type="hidden" id="story-image1" name="story-image1">
                    <input type="text" id="story-image1-url" class="form-control" placeholder="Or paste image URL..." style="margin-top: 5px;" onchange="updateStoryImageFromUrl(this.value, 1)">
                </div>
                <div class="form-group">
                    <label for="story-image2">Story Image 2</label>
                    <div id="story-image2-preview" class="image-preview">
                        <span>No image selected</span>
                    </div>
                    <input type="file" class="form-control" accept="image/*" onchange="handleStoryImageUpload(this, 2)" style="margin-top: 10px;">
                    <input type="hidden" id="story-image2" name="story-image2">
                    <input type="text" id="story-image2-url" class="form-control" placeholder="Or paste image URL..." style="margin-top: 5px;" onchange="updateStoryImageFromUrl(this.value, 2)">
                </div>
            </div>
            
            <button onclick="saveStorySection()" class="btn">Save Story Section</button>
        </div>

        <!-- Quote Section -->
        <div class="section">
            <h2 class="section-title">Quote Section</h2>
            <div class="alert alert-success" id="quote-success"></div>
            <div class="alert alert-error" id="quote-error"></div>
            
            <div class="form-group">
                <label for="quote-text">Quote Text</label>
                <textarea id="quote-text" class="form-control" placeholder="We don't just invest in brands..."></textarea>
            </div>
            
            <div class="form-group">
                <label for="quote-author">Author</label>
                <input type="text" id="quote-author" class="form-control" placeholder="Ventured Brands Leadership Team">
            </div>
            
            <button onclick="saveQuoteSection()" class="btn">Save Quote Section</button>
        </div>

        <!-- Team Section -->
        <div class="section">
            <h2 class="section-title">Team Section</h2>
            <div class="alert alert-success" id="team-success"></div>
            <div class="alert alert-error" id="team-error"></div>
            
            <div class="grid-2">
                <div class="form-group">
                    <label for="team-title">Title</label>
                    <input type="text" id="team-title" class="form-control" placeholder="Meet Our Team">
                </div>
                <div class="form-group">
                    <label for="team-description">Description</label>
                    <textarea id="team-description" class="form-control" placeholder="Our diverse team..."></textarea>
                </div>
            </div>
            
            <div class="form-group">
                <label>Team Members</label>
                <div id="team-members-container"></div>
                <button type="button" onclick="addTeamMember()" class="btn btn-secondary">Add Team Member</button>
            </div>
            
            <button onclick="saveTeamSection()" class="btn">Save Team Section</button>
        </div>
    </div>

    <!-- Gallery Section -->
    <div class="section">
        <h2>Gallery Section</h2>
        <div class="success-message" id="gallery-success"></div>
        <div class="error-message" id="gallery-error"></div>
        
        <div class="form-group">
            <label>Gallery Images (4 slides)</label>
            <div id="gallery-slides-container"></div>
            <button type="button" onclick="addGallerySlide()" class="btn btn-secondary">Add Gallery Slide</button>
        </div>
        
        <button onclick="saveGallerySection()" class="btn">Save Gallery Section</button>
    </div>

    <script>
        let aboutData = {};

        // Load about data on page load
        document.addEventListener('DOMContentLoaded', function() {
            loadAboutData();
        });

        async function loadAboutData() {
            try {
                const response = await fetch('/api/about');
                if (response.ok) {
                    aboutData = await response.json();
                    populateForm();
                } else {
                    console.error('Failed to load about data');
                }
            } catch (error) {
                console.error('Error loading about data:', error);
            }
        }

        function populateForm() {
            // Hero Section
            document.getElementById('hero-subtitle').value = aboutData.hero?.subtitle || '';
            document.getElementById('hero-description').value = aboutData.hero?.description || '';
            document.getElementById('hero-image').value = aboutData.hero?.image || '';
            document.getElementById('hero-image-url').value = aboutData.hero?.image || '';
            document.getElementById('hero-story-title').value = aboutData.hero?.storyTitle || '';
            
            // Update hero image preview
            if (aboutData.hero?.image) {
                updateImagePreview('hero-image-preview', aboutData.hero.image);
            }

            // Story Intro Section
            document.getElementById('story-intro-title').value = aboutData.storyIntro?.title || '';
            document.getElementById('story-intro-description').value = aboutData.storyIntro?.description || '';

            // Story Section
            document.getElementById('story-title').value = aboutData.story?.title || '';
            document.getElementById('story-description').value = aboutData.story?.description || '';
            document.getElementById('story-content').value = aboutData.story?.content || '';
            document.getElementById('story-image1').value = aboutData.story?.image1 || '';
            document.getElementById('story-image1-url').value = aboutData.story?.image1 || '';
            document.getElementById('story-image2').value = aboutData.story?.image2 || '';
            document.getElementById('story-image2-url').value = aboutData.story?.image2 || '';
            
            // Update story image previews
            if (aboutData.story?.image1) {
                updateImagePreview('story-image1-preview', aboutData.story.image1);
            }
            if (aboutData.story?.image2) {
                updateImagePreview('story-image2-preview', aboutData.story.image2);
            }

            // Quote Section
            document.getElementById('quote-text').value = aboutData.quote?.text || '';
            document.getElementById('quote-author').value = aboutData.quote?.author || '';

            // Team Section
            document.getElementById('team-title').value = aboutData.team?.title || '';
            document.getElementById('team-description').value = aboutData.team?.description || '';

            // Populate team members
            const container = document.getElementById('team-members-container');
            container.innerHTML = '';
            if (aboutData.team?.teamMembers) {
                aboutData.team.teamMembers.forEach((member, index) => {
                    addTeamMember(member.name, member.title, member.image, member.alt, member.bio, index);
                });
            }

            // Populate gallery slides
            const galleryContainer = document.getElementById('gallery-slides-container');
            galleryContainer.innerHTML = '';
            if (aboutData.gallery?.slides && aboutData.gallery.slides.length > 0) {
                aboutData.gallery.slides.forEach((slide, index) => {
                    addGallerySlide(slide.image, slide.alt, index);
                });
            } else {
                // Show empty gallery section with placeholder message
                galleryContainer.innerHTML = '<p style="color: #666; font-style: italic; padding: 20px; text-align: center;">No gallery slides added yet. Click "Add Gallery Slide" to get started.</p>';
            }
        }

        function addTeamMember(name = '', title = '', image = '', alt = '', bio = '', index = null) {
            const container = document.getElementById('team-members-container');
            const memberIndex = index !== null ? index : container.children.length;
            
            const memberDiv = document.createElement('div');
            memberDiv.className = 'team-member';
            memberDiv.innerHTML = `
                <div id="team-preview-${memberIndex}" class="team-preview">
                    ${image ? `<img src="/${image}" alt="${alt || 'Team member'}" />` : '<span>No image</span>'}
                </div>
                <div class="team-fields">
                    <div class="form-group">
                        <label>Name</label>
                        <input type="text" id="team-name-${memberIndex}" class="form-control" placeholder="Full Name" value="${name}">
                    </div>
                    <div class="form-group">
                        <label>Title</label>
                        <input type="text" id="team-title-${memberIndex}" class="form-control" placeholder="Job Title" value="${title}">
                    </div>
                    <div class="form-group">
                        <label>Image</label>
                        <input type="file" class="form-control" accept="image/*" onchange="handleTeamUpload(this, ${memberIndex})">
                        <input type="hidden" id="team-image-${memberIndex}" value="${image}">
                    </div>
                    <div class="form-group">
                        <label>Alt Text</label>
                        <input type="text" id="team-alt-${memberIndex}" class="form-control" placeholder="Image description" value="${alt}">
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Bio</label>
                        <textarea id="team-bio-${memberIndex}" class="form-control" placeholder="Brief bio...">${bio}</textarea>
                    </div>
                </div>
                <button type="button" class="team-remove-btn" onclick="removeTeamMember(${memberIndex})">
                    <i class="fas fa-trash"></i>
                </button>
            `;
            container.appendChild(memberDiv);
        }

        function removeTeamMember(index) {
            if (confirm('Are you sure you want to remove this team member?')) {
                const container = document.getElementById('team-members-container');
                const members = Array.from(container.children);
                if (members[index]) {
                    members[index].remove();
                }
            }
        }

        async function handleTeamUpload(input, index) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('file', input.files[0]);

                try {
                    const token = localStorage.getItem('cms_token');
                    const response = await fetch('/api/upload/image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById(`team-image-${index}`).value = data.filePath;
                        const preview = document.getElementById(`team-preview-${index}`);
                        preview.innerHTML = `<img src="/${data.filePath}" alt="Team member preview" />`;
                    } else {
                        alert('Upload failed: ' + data.message);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed');
                }
            }
        }

        async function saveSection(section, data, successId, errorId) {
            try {
                const token = localStorage.getItem('cms_token');
                const response = await fetch(`/api/about/${section}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify(data)
                });

                const result = await response.json();
                
                if (response.ok) {
                    showAlert(successId, result.message || 'Section updated successfully!', 'success');
                    // Update local data
                    aboutData[section] = result.data;
                } else {
                    showAlert(errorId, result.message || 'Failed to update section', 'error');
                }
            } catch (error) {
                console.error('Save error:', error);
                showAlert(errorId, 'Network error occurred', 'error');
            }
        }

        function showAlert(elementId, message, type) {
            const alert = document.getElementById(elementId);
            alert.textContent = message;
            alert.style.display = 'block';
            setTimeout(() => {
                alert.style.display = 'none';
            }, 5000);
        }

        // Image upload and preview functions
        function updateImagePreview(previewId, imageSrc) {
            const preview = document.getElementById(previewId);
            if (imageSrc) {
                preview.innerHTML = `<img src="${imageSrc.startsWith('http') ? imageSrc : '/' + imageSrc}" alt="Preview" />`;
            } else {
                preview.innerHTML = '<span>No image selected</span>';
            }
        }

        async function handleHeroImageUpload(input) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('file', input.files[0]);

                try {
                    const token = localStorage.getItem('cms_token');
                    const response = await fetch('/api/upload/image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById('hero-image').value = data.filePath;
                        document.getElementById('hero-image-url').value = data.filePath;
                        updateImagePreview('hero-image-preview', data.filePath);
                    } else {
                        alert('Upload failed: ' + data.message);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed');
                }
            }
        }

        function updateHeroImageFromUrl(url) {
            document.getElementById('hero-image').value = url;
            updateImagePreview('hero-image-preview', url);
        }

        async function handleStoryImageUpload(input, imageNumber) {
            if (input.files && input.files[0]) {
                const formData = new FormData();
                formData.append('file', input.files[0]);

                try {
                    const token = localStorage.getItem('cms_token');
                    const response = await fetch('/api/upload/image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });

                    const data = await response.json();
                    if (data.success) {
                        document.getElementById(`story-image${imageNumber}`).value = data.filePath;
                        document.getElementById(`story-image${imageNumber}-url`).value = data.filePath;
                        updateImagePreview(`story-image${imageNumber}-preview`, data.filePath);
                    } else {
                        alert('Upload failed: ' + data.message);
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed');
                }
            }
        }

        function updateStoryImageFromUrl(url, imageNumber) {
            document.getElementById(`story-image${imageNumber}`).value = url;
            updateImagePreview(`story-image${imageNumber}-preview`, url);
        }

        async function saveHeroSection() {
            const data = {
                subtitle: document.getElementById('hero-subtitle').value,
                description: document.getElementById('hero-description').value,
                image: document.getElementById('hero-image').value,
                storyTitle: document.getElementById('hero-story-title').value
            };
            await saveSection('hero', data, 'hero-success', 'hero-error');
        }

        async function saveStoryIntroSection() {
            const data = {
                title: document.getElementById('story-intro-title').value,
                description: document.getElementById('story-intro-description').value
            };
            await saveSection('storyIntro', data, 'story-intro-success', 'story-intro-error');
        }

        async function saveStorySection() {
            const data = {
                title: document.getElementById('story-title').value,
                description: document.getElementById('story-description').value,
                content: document.getElementById('story-content').value,
                image1: document.getElementById('story-image1').value,
                image2: document.getElementById('story-image2').value
            };
            await saveSection('story', data, 'story-success', 'story-error');
        }

        async function saveQuoteSection() {
            const data = {
                text: document.getElementById('quote-text').value,
                author: document.getElementById('quote-author').value
            };
            await saveSection('quote', data, 'quote-success', 'quote-error');
        }

        async function saveTeamSection() {
            const teamMembers = [];
            const container = document.getElementById('team-members-container');
            
            Array.from(container.children).forEach((member, index) => {
                const name = document.getElementById(`team-name-${index}`)?.value || '';
                const title = document.getElementById(`team-title-${index}`)?.value || '';
                const image = document.getElementById(`team-image-${index}`)?.value || '';
                const alt = document.getElementById(`team-alt-${index}`)?.value || '';
                const bio = document.getElementById(`team-bio-${index}`)?.value || '';
                
                if (name || title) {
                    teamMembers.push({ name, title, image, alt, bio });
                }
            });

            const data = {
                title: document.getElementById('team-title').value,
                description: document.getElementById('team-description').value,
                teamMembers: teamMembers
            };
            
            await saveSection('team', data, 'team-success', 'team-error');
        }

        function addGallerySlide(image = '', alt = '', index = null) {
            const container = document.getElementById('gallery-slides-container');
            const slideIndex = index !== null ? index : container.children.length;
            
            const slideDiv = document.createElement('div');
            slideDiv.className = 'gallery-slide';
            slideDiv.innerHTML = `
                <div id="gallery-preview-${slideIndex}" class="image-preview">
                    ${image ? `<img src="${image.startsWith('http') ? image : '/' + image}" alt="${alt || 'Gallery image'}" />` : '<span>No image</span>'}
                </div>
                <div class="gallery-fields">
                    <div class="form-group">
                        <label for="gallery-image-${slideIndex}">Image</label>
                        <input type="file" id="gallery-image-${slideIndex}" accept="image/*" onchange="handleGalleryImageUpload(${slideIndex})">
                        <input type="text" id="gallery-image-url-${slideIndex}" placeholder="Or paste image URL" value="${image}" oninput="updateGalleryImagePreview(${slideIndex})">
                    </div>
                    <div class="form-group">
                        <label for="gallery-alt-${slideIndex}">Alt Text</label>
                        <input type="text" id="gallery-alt-${slideIndex}" value="${alt}" placeholder="Image description">
                    </div>
                    <button type="button" onclick="removeGallerySlide(${slideIndex})" class="btn btn-danger">Remove Slide</button>
                </div>
            `;
            
            container.appendChild(slideDiv);
        }

        function removeGallerySlide(index) {
            if (confirm('Are you sure you want to remove this gallery slide?')) {
                const slide = document.querySelector(`#gallery-slides-container .gallery-slide:nth-child(${index + 1})`);
                if (slide) {
                    slide.remove();
                    reindexGallerySlides();
                }
            }
        }

        function reindexGallerySlides() {
            const container = document.getElementById('gallery-slides-container');
            Array.from(container.children).forEach((slide, newIndex) => {
                // Update all IDs and event handlers
                slide.querySelector('.image-preview').id = `gallery-preview-${newIndex}`;
                slide.querySelector('input[type="file"]').id = `gallery-image-${newIndex}`;
                slide.querySelector('input[type="file"]').setAttribute('onchange', `handleGalleryImageUpload(${newIndex})`);
                slide.querySelector('input[type="text"]').id = `gallery-image-url-${newIndex}`;
                slide.querySelector('input[type="text"]').setAttribute('oninput', `updateGalleryImagePreview(${newIndex})`);
                slide.querySelector('input[type="text"]:last-of-type').id = `gallery-alt-${newIndex}`;
                slide.querySelector('button').setAttribute('onclick', `removeGallerySlide(${newIndex})`);
            });
        }

        async function handleGalleryImageUpload(index) {
            const fileInput = document.getElementById(`gallery-image-${index}`);
            const file = fileInput.files[0];
            
            if (file) {
                const token = localStorage.getItem('cms_token');
                console.log('Upload token check:', token ? 'Token exists' : 'No token found');
                
                if (!token) {
                    alert('Authentication token not found. Please refresh the page and try again.');
                    return;
                }
                
                const formData = new FormData();
                formData.append('file', file);
                
                try {
                    const response = await fetch('/api/upload/image', {
                        method: 'POST',
                        headers: {
                            'Authorization': `Bearer ${token}`
                        },
                        body: formData
                    });
                    
                    if (response.status === 401) {
                        alert('Authentication failed. Please log in again.');
                        window.location.href = '/admin/login.html';
                        return;
                    }
                    
                    const result = await response.json();
                    if (result.success) {
                        document.getElementById(`gallery-image-url-${index}`).value = result.filePath;
                        updateGalleryImagePreview(index);
                    } else {
                        console.error('Upload failed:', result);
                        alert('Upload failed: ' + (result.message || 'Unknown error'));
                    }
                } catch (error) {
                    console.error('Upload error:', error);
                    alert('Upload failed: ' + error.message);
                }
            }
        }

        function updateGalleryImagePreview(index) {
            const imageUrl = document.getElementById(`gallery-image-url-${index}`).value;
            const preview = document.getElementById(`gallery-preview-${index}`);
            
            if (imageUrl) {
                // Handle both relative and absolute URLs properly
                const src = imageUrl.startsWith('http') ? imageUrl : `/${imageUrl}`;
                preview.innerHTML = `<img src="${src}" alt="Gallery preview" />`;
            } else {
                preview.innerHTML = '<span>No image</span>';
            }
        }

        async function saveGallerySection() {
            const slides = [];
            const container = document.getElementById('gallery-slides-container');
            
            Array.from(container.children).forEach((slide, index) => {
                const image = document.getElementById(`gallery-image-url-${index}`)?.value || '';
                const alt = document.getElementById(`gallery-alt-${index}`)?.value || '';
                
                if (image) {
                    slides.push({ image, alt });
                }
            });

            const data = { slides };
            await saveSection('gallery', data, 'gallery-success', 'gallery-error');
        }
    </script>
</body>
</html>
